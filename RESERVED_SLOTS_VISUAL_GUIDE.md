# Visual Guide: Reserved Slots Feature

## ğŸ¨ How Reserved Slots Appear to Users

### Time Slot Grid Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Legend:                                                     â”‚
â”‚  â¬œ Available   ğŸŸ§ Being Reserved   ğŸŸ¦ Your Selection       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Morning Slots (9:00 AM - 12:30 PM)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â¬œ 9:00  â”‚ â¬œ 9:30  â”‚ ğŸŸ§ 10:00 â”‚ â¬œ 10:30 â”‚ â¬œ 11:00 â”‚
â”‚   AM    â”‚   AM    â”‚   AM ğŸ• â”‚   AM    â”‚   AM    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â¬œ 11:30 â”‚ â¬œ 12:00 â”‚ â¬œ 12:30 â”‚
â”‚   AM    â”‚   PM    â”‚   PM    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Afternoon Slots (2:00 PM - 5:00 PM)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ§ 2:00  â”‚ â¬œ 2:30  â”‚ â¬œ 3:00  â”‚ ğŸŸ§ 3:30  â”‚ â¬œ 4:00  â”‚
â”‚   PM ğŸ• â”‚   PM    â”‚   PM    â”‚   PM ğŸ• â”‚   PM    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â¬œ 4:30  â”‚ â¬œ 5:00  â”‚
â”‚   PM    â”‚   PM    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
â¬œ = Available (click to select)
ğŸŸ§ = Being Reserved (disabled, another user is booking)
ğŸŸ¦ = Your Selection (after you click)
ğŸ• = Hourglass icon indicating temporary reservation
```

---

## ğŸ”„ Concurrent Booking Flow Diagram

```
Time: 14:30:00 - User A and User B both want 10:00 AM slot
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User A's Screen              Backend/DB              User B's Screen
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Shows: â¬œ 10:00 AM
                                                     Shows: â¬œ 10:00 AM

Clicks 10:00 AM
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                            Reservation Service
                            checks DB for active
                            reservations at 10:00
                            
                            âœ“ No conflicts
                            Creates reservation:
                            {
                              doctorId: "123"
                              slotDateTime: 10:00
                              patientId: "A"
                              status: ACTIVE
                            }
                            
     <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            Success!
Shows: ğŸŸ¦ 10:00 AM                                    [1 second later]
(blue, selected)                                      Clicks 10:00 AM
                                                           â”‚
                                                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€>
                                                      Reservation Service
                                                      checks DB for active
                                                      reservations at 10:00
                                                      
                                                      âœ— CONFLICT FOUND!
                                                      User A already reserved
                                                      
                                                      Returns error
                                                           <â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                      Slot unavailable!
                                                      
                                                      Shows: ğŸŸ§ 10:00 AM ğŸ•
                                                      (orange, disabled)
                                                      Error: "This slot is
                                                      being reserved"

Confirms booking
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
                            AppointmentService
                            1. Checks reservation valid
                            2. Checks no appointment exists
                            3. Creates appointment:
                            {
                              doctorId: "123"
                              appointmentDateTime: 10:00
                              status: SCHEDULED
                            }
                            4. Marks reservation CONFIRMED
                            
     <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            Success!
Redirects to success page
                                                      Refreshes page
                                                           â”‚
                                                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€>
                                                      Gets available slots
                                                      10:00 AM has appointment
                                                      
                                                      âœ— Not in list
                                                           <â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                      
                                                      10:00 AM removed
                                                      (fully booked)
```

---

## ğŸ›¡ï¸ Race Condition Prevention: 3-Layer Protection

```
Layer 1: Application Logic
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  @Transactional                             â”‚
â”‚  public Appointment bookAppointment(...) {  â”‚
â”‚    // Check existing appointments          â”‚
â”‚    if (slotAlreadyBooked) {                â”‚
â”‚      throw Exception                        â”‚
â”‚    }                                        â”‚
â”‚  }                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
          Prevents most conflicts
                    â†“

Layer 2: Database Unique Index
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  @CompoundIndex(                            â”‚
â”‚    def = "{'doctorId': 1,                   â”‚
â”‚           'appointmentDateTime': 1,         â”‚
â”‚           'status': 1}",                    â”‚
â”‚    unique = true,                           â”‚
â”‚    partialFilter = "{'status': 'SCHEDULED'}"â”‚
â”‚  )                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
      Catches simultaneous writes
                    â†“

Layer 3: Reservation Lock
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5-minute temporary reservation             â”‚
â”‚  - Only one ACTIVE per doctor+slot          â”‚
â”‚  - Prevents UI conflicts                    â”‚
â”‚  - Auto-expires if not confirmed            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ User Experience Scenarios

### Scenario 1: Normal Booking (Happy Path)
```
1. User sees all available slots (white)
2. User clicks 10:00 AM â†’ turns blue
3. Backend creates reservation â†’ other users see orange
4. User confirms â†’ appointment created
5. Slot disappears for everyone (booked)

Result: âœ… Successful booking
```

### Scenario 2: Concurrent Booking Attempt
```
1. User A clicks 10:00 AM â†’ turns blue for them
2. User B's screen shows 10:00 AM as orange ğŸ•
3. User B tries to click â†’ button is disabled
4. User B must select different slot

Result: âœ… Prevented confusion, no error
```

### Scenario 3: Race Condition at Backend
```
1. User A and B click simultaneously (rare)
2. Both get reservation request to backend
3. First request succeeds, creates reservation
4. Second request fails â†’ "slot already reserved"
5. Second user sees error, must select new slot

Result: âœ… Backend caught race condition
```

### Scenario 4: Database Race Condition
```
1. User A confirms booking
2. User B bypasses UI checks (hacker?)
3. Both try to create appointment simultaneously
4. MongoDB unique index rejects duplicate
5. Second user gets "duplicate key" error
6. Caught by error handler â†’ friendly message

Result: âœ… Database prevented double booking
```

### Scenario 5: Reservation Expiry
```
1. User A clicks 10:00 AM (reserved, blue)
2. User A gets distracted for 5+ minutes
3. Scheduled cleanup task runs
4. Marks reservation as EXPIRED
5. User B refreshes â†’ sees 10:00 AM as white again
6. User A tries to confirm â†’ "reservation expired"

Result: âœ… Slot freed up, no deadlock
```

---

## ğŸ¨ CSS Color Scheme

```css
/* Available Slot */
.time-slot {
  background: white;
  border: 2px solid #E5E7EB; /* gray-200 */
  color: #111827; /* gray-900 */
}
.time-slot:hover {
  border-color: #2563EB; /* blue-600 */
  background: #EFF6FF; /* blue-50 */
}

/* Reserved Slot (by others) */
.reserved-slot {
  background: #FFF7ED; /* orange-50 */
  border: 2px solid #FDBA74; /* orange-300 */
  color: #C2410C; /* orange-700 */
  cursor: not-allowed;
  opacity: 0.75;
}

/* Selected Slot (by you) */
.selected-slot {
  background: #2563EB; /* blue-600 */
  border: 2px solid #2563EB; /* blue-600 */
  color: white;
}
```

---

## ğŸ“Š State Diagram: Slot Lifecycle

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  AVAILABLE  â”‚
                    â”‚   (White)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                   User clicks slot
                           â”‚
                           â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚    RESERVED      â”‚
                  â”‚    (Orange)      â”‚ â† Other users see this
                  â”‚  by current user â”‚
                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                       â”‚         â”‚
         User confirms â”‚         â”‚ User cancels / 5 min expires
                       â”‚         â”‚
                       â†“         â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   BOOKED    â”‚  â”‚  AVAILABLE  â”‚
              â”‚  (Hidden)   â”‚  â”‚   (White)   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Appointment      Returns to
              created          available pool
```

---

## ğŸ” Debugging: What to Check

### If slots appear "stuck" as reserved:
1. Check scheduled cleanup task is running:
   ```
   Look for log: "Cleaned up X expired reservations"
   ```

2. Manually check MongoDB:
   ```javascript
   db.time_slot_reservations.find({status: "ACTIVE"})
   ```

3. Check createdAt timestamps (should be < 5 min old)

### If double bookings occur:
1. Verify indexes exist:
   ```javascript
   db.appointments.getIndexes()
   // Should see unique_scheduled_appointment_idx
   ```

2. Check MongoDB version (needs 4.0+ for partial indexes)

3. Look for duplicate key errors in logs

### If UI doesn't show reserved slots:
1. Check controller returns both lists:
   ```java
   model.addAttribute("reservedSlots", reservedSlots);
   ```

2. Verify Thymeleaf template loops over reserved slots:
   ```html
   <div th:each="slot : ${morningReservedSlots}">
   ```

3. Check browser console for JavaScript errors

---

## ğŸ“± Mobile Responsive Behavior

```
Desktop (5 columns):
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚9:00â”‚9:30â”‚10:0â”‚10:3â”‚11:0â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜

Tablet (4 columns):
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚9:00â”‚9:30â”‚10:0â”‚10:3â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”
â”‚11:0â”‚
â””â”€â”€â”€â”€â”˜

Mobile (3 columns):
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚9:00â”‚9:30â”‚10:0â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚10:3â”‚11:0â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜

Classes: grid-cols-3 sm:grid-cols-4 md:grid-cols-5
```

---

## âœ… Testing Commands

### Test 1: Verify indexes created
```javascript
// MongoDB Shell
use healthcare_db
db.appointments.getIndexes()
db.time_slot_reservations.getIndexes()
```

### Test 2: Simulate concurrent booking
```bash
# Terminal 1
curl -X POST http://localhost:8080/appointments/reserve-slot \
  -d "doctorId=123&date=2025-10-17&time=10:00"

# Terminal 2 (immediately)
curl -X POST http://localhost:8080/appointments/reserve-slot \
  -d "doctorId=123&date=2025-10-17&time=10:00"

# Expected: Second request fails with "already reserved"
```

### Test 3: Check cleanup task
```bash
# Wait 6 minutes after creating reservation
# Check MongoDB
db.time_slot_reservations.find({status: "EXPIRED"})
# Should show expired reservations
```

---

**Implementation Complete! ğŸ‰**

The system now has:
- âœ… Visual indicators for all slot states
- âœ… Three layers of race condition protection
- âœ… Clear user feedback
- âœ… Robust error handling
- âœ… Database integrity constraints

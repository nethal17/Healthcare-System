<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - Healthcare System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Include navbar -->
    <div th:replace="~{fragments/navbar :: navbar(${user})}"></div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                Reports & Analytics
            </h1>
            <p class="text-gray-600">Comprehensive insights into appointment trends, doctor performance, and patient behavior</p>
        </div>

        <!-- Date Range Filter -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <form method="get" action="/admin/analytics" class="flex flex-wrap items-end gap-4">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                    <input type="date" name="startDate" th:value="${startDate}" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                    <input type="date" name="endDate" th:value="${endDate}" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    <i class="fas fa-filter mr-2"></i>Apply Filter
                </button>
                <button type="button" onclick="exportPdf()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">
                    <i class="fas fa-file-pdf mr-2"></i>Export PDF
                </button>
            </form>
        </div>

        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Appointments -->
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium opacity-90">Total Appointments</h3>
                    <i class="fas fa-calendar-check text-2xl opacity-80"></i>
                </div>
                <p class="text-3xl font-bold" th:text="${totalAppointments}">0</p>
                <p class="text-xs opacity-75 mt-2">In selected period</p>
            </div>

            <!-- Completion Rate -->
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium opacity-90">Completion Rate</h3>
                    <i class="fas fa-check-circle text-2xl opacity-80"></i>
                </div>
                <p class="text-3xl font-bold"><span th:text="${completionRate}">0</span>%</p>
                <p class="text-xs opacity-75 mt-2"><span th:text="${completedCount}">0</span> completed</p>
            </div>

            <!-- Active Doctors -->
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium opacity-90">Active Doctors</h3>
                    <i class="fas fa-user-md text-2xl opacity-80"></i>
                </div>
                <p class="text-3xl font-bold" th:text="${uniqueDoctors}">0</p>
                <p class="text-xs opacity-75 mt-2">With appointments</p>
            </div>

            <!-- Active Patients -->
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium opacity-90">Active Patients</h3>
                    <i class="fas fa-user-injured text-2xl opacity-80"></i>
                </div>
                <p class="text-3xl font-bold" th:text="${uniquePatients}">0</p>
                <p class="text-xs opacity-75 mt-2">With appointments</p>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Most Booked Time Slots -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-clock text-blue-600 mr-2"></i>
                    Most Booked Time Slots
                </h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="timeSlotChart"></canvas>
                </div>
            </div>

            <!-- Appointments by Day of Week -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-calendar-week text-green-600 mr-2"></i>
                    Appointments by Day of Week
                </h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="dayOfWeekChart"></canvas>
                </div>
            </div>

            <!-- Top Doctors by Appointments -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-trophy text-yellow-600 mr-2"></i>
                    Top Doctors by Appointments
                </h3>
                <div style="position: relative; height: 400px;">
                    <canvas id="topDoctorsChart"></canvas>
                </div>
            </div>

            <!-- Specialization Demand -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-stethoscope text-purple-600 mr-2"></i>
                    Specialization Demand
                </h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="specializationChart"></canvas>
                </div>
            </div>

            <!-- Peak Hours Analysis -->
            <div class="bg-white rounded-xl shadow-lg p-6 lg:col-span-2">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-area text-indigo-600 mr-2"></i>
                    Peak Hours Analysis
                </h3>
                <div style="position: relative; height: 200px;">
                    <canvas id="peakHoursChart"></canvas>
                </div>
            </div>

            <!-- Appointment Status Distribution -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-pie text-pink-600 mr-2"></i>
                    Appointment Status
                </h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <!-- Monthly Trend -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chart-line text-teal-600 mr-2"></i>
                    6-Month Trend
                </h3>
                <div style="position: relative; height: 300px;">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Statistics Table -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-table text-gray-700 mr-2"></i>
                Detailed Statistics
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="border-l-4 border-blue-500 pl-4">
                    <p class="text-sm text-gray-600">Scheduled</p>
                    <p class="text-2xl font-bold text-gray-800" th:text="${scheduledCount}">0</p>
                </div>
                <div class="border-l-4 border-green-500 pl-4">
                    <p class="text-sm text-gray-600">Completed</p>
                    <p class="text-2xl font-bold text-gray-800" th:text="${completedCount}">0</p>
                </div>
                <div class="border-l-4 border-red-500 pl-4">
                    <p class="text-sm text-gray-600">Cancelled</p>
                    <p class="text-2xl font-bold text-gray-800" th:text="${cancelledCount}">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js Scripts -->
    <script th:inline="javascript">
        // Data from Thymeleaf
        const timeSlotData = /*[[${timeSlotData}]]*/ {};
        const dayOfWeekData = /*[[${dayOfWeekData}]]*/ {};
        const topDoctorsData = /*[[${topDoctorsData}]]*/ {};
        const specializationData = /*[[${specializationData}]]*/ {};
        const statusData = /*[[${statusData}]]*/ {};
        const monthlyData = /*[[${monthlyData}]]*/ {};
        const peakHoursData = /*[[${peakHoursData}]]*/ {};

        // Color palettes
        const colorPalette = [
            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
            '#EC4899', '#14B8A6', '#F97316', '#6366F1', '#84CC16'
        ];

        // 1. Time Slot Chart
        new Chart(document.getElementById('timeSlotChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(timeSlotData),
                datasets: [{
                    label: 'Appointments',
                    data: Object.values(timeSlotData),
                    backgroundColor: '#3B82F6',
                    borderColor: '#2563EB',
                    borderWidth: 1,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + ' appointments';
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        ticks: { 
                            stepSize: 1,
                            font: { size: 11 }
                        }
                    },
                    x: {
                        ticks: {
                            font: { size: 10 },
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });

        // 2. Day of Week Chart
        new Chart(document.getElementById('dayOfWeekChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(dayOfWeekData),
                datasets: [{
                    label: 'Appointments',
                    data: Object.values(dayOfWeekData),
                    backgroundColor: '#10B981',
                    borderColor: '#059669',
                    borderWidth: 1,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + ' appointments';
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        ticks: { 
                            stepSize: 1,
                            font: { size: 11 }
                        }
                    },
                    x: {
                        ticks: {
                            font: { size: 11 }
                        }
                    }
                }
            }
        });

        // 3. Top Doctors Chart (Fixed for Chart.js 4.x)
        new Chart(document.getElementById('topDoctorsChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(topDoctorsData),
                datasets: [{
                    label: 'Appointments',
                    data: Object.values(topDoctorsData),
                    backgroundColor: colorPalette,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.x + ' appointments';
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        beginAtZero: true, 
                        ticks: { 
                            stepSize: 1,
                            font: { size: 11 }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        ticks: {
                            font: { size: 11 },
                            autoSkip: false
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 20,
                        top: 10,
                        bottom: 10
                    }
                }
            }
        });

        // 4. Specialization Chart
        new Chart(document.getElementById('specializationChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(specializationData),
                datasets: [{
                    data: Object.values(specializationData),
                    backgroundColor: colorPalette,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { 
                            padding: 12, 
                            font: { size: 11 },
                            boxWidth: 15,
                            boxHeight: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.parsed;
                                const percentage = ((value / total) * 100).toFixed(1);
                                return context.label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });

        // 5. Peak Hours Chart
        new Chart(document.getElementById('peakHoursChart'), {
            type: 'line',
            data: {
                labels: Object.keys(peakHoursData),
                datasets: [{
                    label: 'Appointments',
                    data: Object.values(peakHoursData),
                    backgroundColor: 'rgba(99, 102, 241, 0.2)',
                    borderColor: '#6366F1',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#6366F1',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + ' appointments';
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        ticks: { 
                            stepSize: 1,
                            font: { size: 11 }
                        }
                    },
                    x: {
                        ticks: {
                            font: { size: 11 }
                        }
                    }
                }
            }
        });

        // 6. Status Chart
        new Chart(document.getElementById('statusChart'), {
            type: 'pie',
            data: {
                labels: Object.keys(statusData),
                datasets: [{
                    data: Object.values(statusData),
                    backgroundColor: ['#3B82F6', '#10B981', '#EF4444', '#F59E0B'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { 
                            padding: 12,
                            font: { size: 11 },
                            boxWidth: 15,
                            boxHeight: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.parsed;
                                const percentage = ((value / total) * 100).toFixed(1);
                                return context.label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });

        // 7. Monthly Chart
        new Chart(document.getElementById('monthlyChart'), {
            type: 'line',
            data: {
                labels: Object.keys(monthlyData),
                datasets: [{
                    label: 'Appointments',
                    data: Object.values(monthlyData),
                    backgroundColor: 'rgba(20, 184, 166, 0.2)',
                    borderColor: '#14B8A6',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#14B8A6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y + ' appointments';
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        ticks: { 
                            stepSize: 1,
                            font: { size: 11 }
                        }
                    },
                    x: {
                        ticks: {
                            font: { size: 10 },
                            maxRotation: 0,
                            minRotation: 0
                        }
                    }
                }
            }
        });

        // PDF Export Function
        function exportPdf() {
            const startDate = document.querySelector('input[name="startDate"]').value;
            const endDate = document.querySelector('input[name="endDate"]').value;
            
            let url = '/admin/analytics/export-pdf';
            const params = new URLSearchParams();
            
            if (startDate) {
                params.append('startDate', startDate);
            }
            if (endDate) {
                params.append('endDate', endDate);
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            // Open PDF in new window
            window.open(url, '_blank');
        }
    </script>
</body>
</html>

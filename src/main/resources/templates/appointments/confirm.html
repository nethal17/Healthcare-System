<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - Confirm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Include navbar -->
    <div th:replace="~{fragments/navbar :: navbar(${user})}"></div>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Progress Steps -->
        <div class="mb-8">
            <div class="flex items-center justify-center">
                <!-- Step 1 -->
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-10 h-10 bg-green-600 text-white rounded-full font-bold">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="ml-2 text-green-600 font-semibold">Select Hospital</span>
                </div>
                
                <div class="w-24 h-1 bg-green-600 mx-4"></div>
                
                <!-- Step 2 -->
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-10 h-10 bg-green-600 text-white rounded-full font-bold">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="ml-2 text-green-600 font-semibold">Select Doctor</span>
                </div>
                
                <div class="w-24 h-1 bg-green-600 mx-4"></div>
                
                <!-- Step 3 -->
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-10 h-10 bg-green-600 text-white rounded-full font-bold">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="ml-2 text-green-600 font-semibold">Select Time Slot</span>
                </div>
                
                <div class="w-24 h-1 bg-green-600 mx-4"></div>
                
                <!-- Step 4 -->
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-10 h-10 bg-blue-600 text-white rounded-full font-bold">
                        4
                    </div>
                    <span class="ml-2 text-blue-600 font-semibold">Confirm</span>
                </div>
            </div>
        </div>

        <!-- Page Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Confirm Your Appointment</h1>
            <p class="text-gray-600">Please review and confirm your appointment details</p>
            
            <!-- Reservation Timer -->
            <div id="reservationTimer" class="mt-4 inline-block bg-yellow-100 border-2 border-yellow-400 rounded-lg px-6 py-3">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                    <div>
                        <p class="text-sm text-yellow-800 font-semibold">Time slot reserved for:</p>
                        <p class="text-2xl font-bold text-yellow-900">
                            <span id="minutes">5</span>:<span id="seconds">00</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appointment Details Card -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white">
                <h2 class="text-2xl font-bold mb-2">Appointment Details</h2>
                <p class="text-blue-100">Review your booking information</p>
            </div>

            <!-- Content -->
            <div class="p-6 space-y-6">
                <!-- Patient Information -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-user text-blue-600 mr-2"></i>
                        Patient Information
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Name:</p>
                            <p class="font-semibold text-gray-900" th:text="${patient.name}">Patient Name</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Patient ID:</p>
                            <p class="font-semibold text-gray-900" th:text="${patient.id}">Patient ID</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Email:</p>
                            <p class="font-semibold text-gray-900" th:text="${patient.email}">Email</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Contact:</p>
                            <p class="font-semibold text-gray-900" th:text="${patient.contactNumber}">Contact</p>
                        </div>
                    </div>
                </div>

                <!-- Hospital Information -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-hospital text-blue-600 mr-2"></i>
                        Hospital Information
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Hospital Name:</p>
                            <p class="font-semibold text-gray-900" th:text="${hospital.name}">Hospital Name</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Type:</p>
                            <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full"
                                  th:classappend="${hospital.type.name() == 'GOVERNMENT'} ? 'bg-green-100 text-green-800' : 'bg-purple-100 text-purple-800'"
                                  th:text="${hospital.type}">
                                Type
                            </span>
                        </div>
                        <div class="md:col-span-2" th:if="${hospital.location != null}">
                            <p class="text-sm text-gray-600">Address:</p>
                            <p class="font-semibold text-gray-900">
                                <span th:text="${hospital.location.address}">Address</span>,
                                <span th:text="${hospital.location.city}">City</span>,
                                <span th:text="${hospital.location.state}">State</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Doctor Information -->
                <div class="border-b pb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-user-md text-blue-600 mr-2"></i>
                        Doctor Information
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Doctor Name:</p>
                            <p class="font-semibold text-gray-900" th:text="'Dr. ' + ${doctor.name}">Dr. Name</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Specialization:</p>
                            <p class="font-semibold text-blue-600" th:text="${doctor.specialization}">Specialization</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Doctor ID:</p>
                            <p class="font-semibold text-gray-900" th:text="${doctor.id}">Doctor ID</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Email:</p>
                            <p class="font-semibold text-gray-900" th:text="${doctor.email}">Email</p>
                        </div>
                    </div>
                </div>

                <!-- Appointment Time -->
                <div class="bg-blue-50 rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-calendar-check text-blue-600 mr-2"></i>
                        Appointment Date & Time
                    </h3>
                    <div class="flex items-center justify-center space-x-8 py-4">
                        <div class="text-center">
                            <i class="fas fa-calendar-alt text-blue-600 text-3xl mb-2"></i>
                            <p class="text-sm text-gray-600">Date</p>
                            <p class="text-xl font-bold text-gray-900" 
                               th:text="${#temporals.format(selectedDate, 'MMM dd, yyyy')}">Date</p>
                            <p class="text-sm text-gray-600" 
                               th:text="${#temporals.format(selectedDate, 'EEEE')}">Day</p>
                        </div>
                        <div class="text-4xl text-gray-300">|</div>
                        <div class="text-center">
                            <i class="fas fa-clock text-blue-600 text-3xl mb-2"></i>
                            <p class="text-sm text-gray-600">Time</p>
                            <p class="text-xl font-bold text-gray-900" 
                               th:text="${#temporals.format(selectedTime, 'h:mm a')}">Time</p>
                            <p class="text-sm text-gray-600">30 minutes</p>
                        </div>
                    </div>
                </div>

                <!-- Hospital Charges (Only for Private Hospitals) -->
                <div class="border-t pt-4" th:if="${hospital.type.name() == 'PRIVATE'}">
                    <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-money-bill-wave text-blue-600 mr-2"></i>
                        Hospital Charges
                    </h3>
                    <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">Consultation Fee</p>
                                <p class="text-gray-700 text-sm">This amount will be charged for the appointment</p>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-green-700" 
                                   th:text="'Rs. ' + ${#numbers.formatDecimal(hospital.hospitalCharges, 1, 2)}">Rs. 0.00</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-yellow-600 mt-1 mr-2"></i>
                            <p class="text-sm text-yellow-800">
                                <strong>Note:</strong> The hospital charge will be processed during your visit. 
                                Please bring the required payment method.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Free Service Notice (Only for Government Hospitals) -->
                <div class="border-t pt-4" th:if="${hospital.type.name() == 'GOVERNMENT'}">
                    <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-600 text-3xl mr-4"></i>
                            <div>
                                <h3 class="text-lg font-semibold text-green-800 mb-1">Free Consultation</h3>
                                <p class="text-gray-700 text-sm">
                                    This is a government hospital. No consultation charges will be applied for this appointment.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Form -->
        <form th:action="@{/appointments/book/process}" method="post" id="bookingForm">
            <input type="hidden" name="doctorId" th:value="${doctor.id}">
            <input type="hidden" name="date" th:value="${selectedDate}">
            <input type="hidden" name="time" th:value="${selectedTime}">
            <input type="hidden" name="hospitalId" th:value="${hospital.id}">
            <input type="hidden" name="hospitalType" th:value="${hospital.type.name()}">
            
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Additional Information (Optional)</h3>
                
                <div class="space-y-4">
                    <div>
                        <label for="purpose" class="block text-sm font-medium text-gray-700 mb-2">
                            Purpose of Visit
                        </label>
                        <input type="text" 
                               id="purpose" 
                               name="purpose" 
                               placeholder="e.g., General Checkup, Follow-up, Consultation"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                            Additional Notes
                        </label>
                        <textarea id="notes" 
                                  name="notes" 
                                  rows="3"
                                  placeholder="Any symptoms, concerns, or special requirements..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-between items-center">
                <a th:href="@{/appointments/book/select-timeslot(hospitalId=${hospital.id}, doctorId=${doctor.id}, date=${selectedDate})}" 
                   class="text-blue-600 hover:text-blue-800 font-semibold">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Time Slots
                </a>
                
                <div class="space-x-4">
                    <a href="/dashboard" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-semibold">
                        Cancel
                    </a>
                    <!-- Show different button text based on hospital type -->
                    <button type="submit" 
                            id="confirmButton"
                            class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold shadow-lg transition-colors duration-200">
                        <i th:class="${hospital.type.name() == 'GOVERNMENT'} ? 'fas fa-check mr-2' : 'fas fa-arrow-right mr-2'"></i>
                        <span th:text="${hospital.type.name() == 'GOVERNMENT'} ? 'Confirm Appointment' : 'Proceed to Payment'">Proceed to Payment</span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        const hospitalId = /*[[${hospital.id}]]*/ '';
        const doctorId = /*[[${doctor.id}]]*/ '';
        const selectedDate = /*[[${selectedDate}]]*/ '';
        const selectedTime = /*[[${selectedTime}]]*/ '';
        
        let timerInterval;
        let remainingSeconds = 300; // 5 minutes
        let checkAttempts = 0;
        const MAX_CHECK_ATTEMPTS = 3;
        
        // Check reservation status and get remaining time
        function checkReservationStatus() {
            checkAttempts++;
            console.log('Checking reservation status, attempt:', checkAttempts);
            
            fetch('/appointments/check-reservation')
                .then(response => response.json())
                .then(data => {
                    console.log('Reservation check response:', data); // Debug log
                    
                    if (data.success && data.isValid && data.remainingSeconds > 0) {
                        remainingSeconds = data.remainingSeconds;
                        console.log('Reservation valid, remaining seconds:', remainingSeconds);
                        startTimer();
                    } else if (data.success && !data.isValid && checkAttempts < MAX_CHECK_ATTEMPTS) {
                        // Reservation not found yet, might be timing issue, retry after short delay
                        console.log('Reservation not found, retrying in 500ms...');
                        setTimeout(() => checkReservationStatus(), 500);
                    } else if (data.success && data.isValid && data.remainingSeconds === 0) {
                        // Reservation exists but expired
                        console.warn('Reservation expired');
                        showExpiredMessage();
                    } else {
                        console.warn('Reservation not valid or max attempts reached:', data);
                        // Start timer with default 5 minutes as fallback
                        console.log('Starting timer with default 5 minutes (fallback)');
                        startTimer();
                    }
                })
                .catch(error => {
                    console.error('Error checking reservation:', error);
                    // Start timer anyway as fallback - user just made reservation
                    console.log('Starting timer due to error (fallback)');
                    startTimer();
                });
        }
        
        function startTimer() {
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                remainingSeconds--;
                
                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    showExpiredMessage();
                } else {
                    updateTimerDisplay();
                    
                    // Change color when less than 1 minute remaining
                    if (remainingSeconds <= 60) {
                        const timerDiv = document.getElementById('reservationTimer');
                        timerDiv.classList.remove('bg-yellow-100', 'border-yellow-400');
                        timerDiv.classList.add('bg-red-100', 'border-red-400');
                        
                        const icon = timerDiv.querySelector('i');
                        icon.classList.remove('text-yellow-600');
                        icon.classList.add('text-red-600');
                        
                        const texts = timerDiv.querySelectorAll('p');
                        texts[0].classList.remove('text-yellow-800');
                        texts[0].classList.add('text-red-800');
                        texts[1].classList.remove('text-yellow-900');
                        texts[1].classList.add('text-red-900');
                    }
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            
            document.getElementById('minutes').textContent = minutes;
            document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
        }
        
        function showExpiredMessage() {
            const timerDiv = document.getElementById('reservationTimer');
            timerDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                    <div>
                        <p class="text-sm text-red-800 font-semibold">Reservation Expired!</p>
                        <p class="text-sm text-red-700">Redirecting to time slot selection...</p>
                    </div>
                </div>
            `;
            timerDiv.classList.remove('bg-yellow-100', 'border-yellow-400');
            timerDiv.classList.add('bg-red-100', 'border-red-400');
            
            // Disable confirm button
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = true;
            confirmButton.classList.add('opacity-50', 'cursor-not-allowed');
            
            // Redirect after 3 seconds
            setTimeout(() => {
                window.location.href = `/appointments/book/select-timeslot?hospitalId=${hospitalId}&doctorId=${doctorId}&date=${selectedDate}`;
            }, 3000);
        }
        
        // Handle form submission
        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            clearInterval(timerInterval);
            const button = document.getElementById('confirmButton');
            const hospitalType = document.querySelector('input[name="hospitalType"]').value;
            button.disabled = true;
            if (hospitalType === 'GOVERNMENT') {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Confirming Appointment...';
            } else {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
            }
        });
        
        // Handle back button - release reservation
        document.querySelector('a[href*="select-timeslot"]').addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.href;
            
            fetch('/appointments/release-slot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            }).finally(() => {
                window.location.href = href;
            });
        });
        
        // Handle cancel button - release reservation
        document.querySelector('a[href="/dashboard"]').addEventListener('click', function(e) {
            e.preventDefault();
            
            fetch('/appointments/release-slot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            }).finally(() => {
                window.location.href = '/dashboard';
            });
        });
        
        // Release reservation when navigating away
        window.addEventListener('beforeunload', function() {
            if (remainingSeconds > 0) {
                navigator.sendBeacon('/appointments/release-slot', new URLSearchParams());
            }
        });
        
        // Start checking reservation on page load
        checkReservationStatus();
    </script>
</body>
</html>
